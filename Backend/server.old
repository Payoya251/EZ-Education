require('dotenv').config();
const express = require('express');
const path = require('path');
const { MongoClient, ServerApiVersion, ObjectId } = require('mongodb');
const bcrypt = require('bcryptjs');
const cors = require('cors');
const fs = require('fs');

const app = express();
const port = process.env.PORT || 3000;

// Enable debug logging
process.env.DEBUG = 'app:*';

// Database configuration
const uri = process.env.MONGODB_URI || "mongodb+srv://anthonyventura2324:36kgQwCf6zqWEiDa@smartkidstutoring.jahng0c.mongodb.net/SmartKidsTutoring?retryWrites=true&w=majority";
const dbName = process.env.DB_NAME || "SmartKidsTutoring";

if (!uri) {
    console.error("❌ MONGODB_URI environment variable not set!");
    process.exit(1);
}

// CORS Configuration
const allowedOrigins = ['http://localhost:3000', 'http://127.0.0.1:3000', 'http://localhost:5500', 'http://127.0.0.1:5500'];

const corsOptions = {
  origin: function (origin, callback) {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  optionsSuccessStatus: 200
};

// Middleware
app.use(cors(corsOptions));
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// Debug middleware to log all routes as they are registered
const originalUse = app.use;
const originalGet = app.get;
const originalPost = app.post;

app.use = function(...args) {
    console.log(`[ROUTE] Registering middleware for:`, args[0] || '/');
    return originalUse.apply(this, args);
};

app.get = function(path, ...handlers) {
    console.log(`[ROUTE] Registering GET: ${path}`);
    return originalGet.call(this, path, ...handlers);
};

app.post = function(path, ...handlers) {
    console.log(`[ROUTE] Registering POST: ${path}`);
    return originalPost.call(this, path, ...handlers);
};

// Log all incoming requests
app.use((req, res, next) => {
    console.log(`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`);
    next();
});

// MongoDB connection
let db;
async function connectToMongoDB() {
    try {
        const client = new MongoClient(uri, {
            serverApi: {
                version: ServerApiVersion.v1,
                strict: true,
                deprecationErrors: true,
            }
        });
        
        await client.connect();
        db = client.db(dbName);
        
        console.log('✅ Connected to MongoDB!');
        
        // List all databases
        const adminDb = client.db().admin();
        const databases = await adminDb.listDatabases();
        console.log('Available databases:', databases.databases.map(d => d.name));
        
        // List collections in the current database
        const collections = await db.listCollections().toArray();
        console.log('Collections in database:', collections.map(c => c.name));
        
    } catch (error) {
        console.error('❌ MongoDB connection error:', error);
        process.exit(1);
    }
}

// ======================
// API Routes
// ======================

// Health check endpoint
app.get('/api/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// Tutor students endpoint
app.get('/api/tutor-students/:tutorUsername', async (req, res) => {
    try {
        const { tutorUsername } = req.params;
        
        console.log(`[DEBUG] ===== TUTOR STUDENTS REQUEST =====`);
        console.log(`[DEBUG] Tutor username: ${tutorUsername}`);
        
        if (!tutorUsername) {
            console.error('[ERROR] No tutorUsername provided in request');
            return res.status(400).json({
                success: false,
                message: 'Tutor username is required'
            });
        }
        
        // Find all students assigned to this tutor (case-insensitive match)
        const students = await db.collection('users').find({
            assignedTutor: { $regex: `^${tutorUsername}$`, $options: 'i' },
            role: 'student'
        }).toArray();
        
        // Return just the necessary student information
        const studentData = students.map(student => ({
            username: student.username,
            name: student.name || student.username,
            email: student.email
        }));
        
        console.log(`[DEBUG] Found ${studentData.length} students for tutor ${tutorUsername}`);
        
        res.json({
            success: true,
            students: studentData
        });
        
    } catch (error) {
        console.error('Error in /api/tutor-students:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching students',
            error: error.message
        });
    }
});

// ======================
// Static File Serving
// ======================

// Path configuration
const frontendPath = path.join(__dirname, '..', 'Frontend');
console.log('Frontend path:', frontendPath);

// Verify the frontend directory exists
if (!fs.existsSync(frontendPath)) {
  console.error('❌ Frontend path does not exist:', frontendPath);
  process.exit(1);
}
console.log('✅ Frontend path exists');

// Serve static files from the frontend directory
app.use(express.static(frontendPath));

// Route for the root path
app.get('/', (req, res) => {
  res.sendFile(path.join(frontendPath, 'Homepage.html'));
});

// Route for other HTML files
const htmlFiles = [
  'login',
  'signup',
  'contact',
  'products',
  'student_dashboard',
  'tutor_dashboard'
];

htmlFiles.forEach(file => {
  app.get(`/${file}`, (req, res) => {
    res.sendFile(path.join(frontendPath, `${file}.html`));
  });
});

// ======================
// API Routes (continued)
// ======================

// Contact form submission endpoint
app.post('/api/contact', async (req, res) => {
  try {
    const { name, email, subject, message } = req.body;
    
    // Basic validation
    if (!name || !email || !subject || !message) {
      return res.status(400).json({ 
        success: false, 
        message: 'All fields are required' 
      });
    }
    
    // Save contact to database
    const result = await db.collection('contact').insertOne({
      name,
      email,
      subject,
      message,
      createdAt: new Date()
    });
    
    res.json({
      success: true,
      message: 'Message sent successfully',
      data: result.ops[0]
    });
  } catch (error) {
    console.error('Error saving contact:', error);
    res.status(500).json({
      success: false,
      message: 'Error sending message',
      error: error.message
    });
  }
});

// Initialize MongoDB connection
connectToMongoDB();

// Start the server
app.listen(port, '0.0.0.0', () => {
  console.log(`\n=== Server Started ===`);
  console.log(`🚀 Server running on http://0.0.0.0:${port}`);
  console.log('Available endpoints:');
  console.log('- GET  /');
  console.log('- GET  /login');
  console.log('- GET  /signup');
  console.log('- GET  /contact');
  console.log('- GET  /products');
  console.log('=====================');
});

// Login endpoint
app.post('/api/login', async (req, res) => {
  try {
    const { username, password } = req.body;
    
    // Find user by username or email
    const user = await db.collection('users').findOne({
      $or: [
        { username },
        { email: username }
      ]
    });
    
    if (!user) {
      return res.status(401).json({
        success: false,
        message: 'Invalid credentials'
      });
    }
    
    // Verify password
    const isMatch = await bcrypt.compare(password, user.password);
    
    if (!isMatch) {
      return res.status(401).json({
        success: false,
        message: 'Invalid credentials'
      });
    }
    
    // Create user object without password
    const userObj = { ...user };
    delete userObj.password;
    
    res.json({
      success: true,
      message: 'Login successful',
      user: userObj,
      token: 'your-jwt-token-here'
    });
  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({
      success: false,
      message: 'Server error during login'
    });
  }
});

// Path configuration
const frontendPath = path.join(__dirname, '..', 'Frontend');
console.log('Frontend path:', frontendPath);

// Verify the frontend directory exists
if (!fs.existsSync(frontendPath)) {
  console.error('❌ Frontend path does not exist:', frontendPath);
  process.exit(1);
}
console.log('✅ Frontend path exists');

// Serve static files from the frontend directory
app.use(express.static(frontendPath));

// Route for the root path
app.get('/', (req, res) => {
  res.sendFile(path.join(frontendPath, 'Homepage.html'));
});

// Route for other HTML files
const htmlFiles = [
  'login',
  'signup',
  'contact',
  'products',
  'student_dashboard',
  'tutor_dashboard'
];

htmlFiles.forEach(file => {
  app.get(`/${file}`, (req, res) => {
    res.sendFile(path.join(frontendPath, `${file}.html`));
  });
});

// Connect to MongoDB
let db;
let client;

async function connectToMongoDB() {
  try {
    console.log('Connecting to MongoDB with URI:', uri.replace(/:[^:]*?@/, ':*****@'));
    client = new MongoClient(uri, {
      serverApi: {
        version: ServerApiVersion.v1,
        strict: true,
        deprecationErrors: true,
      }
    });

    await client.connect();
    console.log('✅ Connected to MongoDB!');
    
    // List all databases to verify connection
    const adminDb = client.db().admin();
    const dbList = await adminDb.listDatabases();
    console.log('Available databases:', dbList.databases.map(d => d.name));
    
    // Connect to the specific database
    db = client.db('SmartKidsTutoring');
    console.log(`✅ Using database: ${db.databaseName}`);
    
    // Verify the users collection exists
    const collections = await db.listCollections().toArray();
    console.log('Collections in database:', collections.map(c => c.name));
    
  } catch (error) {
    console.error('❌ MongoDB connection error:', error);
    process.exit(1);
  }
}

// Initialize MongoDB connection
connectToMongoDB();

// Contact form submission endpoint
app.post('/api/contact', async (req, res) => {
  try {
    const { name, email, subject, message } = req.body;
    
    // Basic validation
    if (!name || !email || !subject || !message) {
      return res.status(400).json({ 
        success: false, 
        message: 'All fields are required' 
      });
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return res.status(400).json({ 
        success: false, 
        message: 'Please enter a valid email address' 
      });
    }
    
    // Save the contact form data to MongoDB
    const contact = {
      name,
      email,
      subject,
      message,
      createdAt: new Date(),
      status: 'new'
    };
    
    // Insert the contact into the 'contact' collection
    const result = await db.collection('contact').insertOne(contact);
    console.log(`New contact form submission from: ${name} (${email})`, result);
    
    res.status(200).json({
      success: true,
      message: 'Thank you for your message! We will get back to you soon.'
    });
    
  } catch (error) {
    console.error('Error processing contact form:', error);
    res.status(500).json({
      success: false,
      message: 'An error occurred while processing your message. Please try again later.'
    });
  }
});

// Login endpoint
app.post('/api/login', async (req, res) => {
  console.log('\n=== Login Request ===');
  console.log('Headers:', JSON.stringify(req.headers, null, 2));
  console.log('Body:', JSON.stringify(req.body, null, 2));
  
  const { username, password } = req.body;
  
  try {
    console.log(`Login attempt for username: ${username}`);
    
    console.log('Looking up user in database...');
    const user = await db.collection('users').findOne({
      $or: [
        { username: { $regex: `^${username}$`, $options: 'i' } },
        { email: { $regex: `^${username}$`, $options: 'i' } }
      ]
    });
    
    if (!user) {
      console.log('No user found with username/email:', username);
      return res.status(401).json({
        success: false,
        message: 'Invalid username/email or password'
      });
    }
    
    console.log('User found, comparing passwords...');
    const isMatch = await bcrypt.compare(password, user.password);
    
    if (!isMatch) {
      console.log('Password does not match');
      return res.status(401).json({
        success: false,
        message: 'Invalid username/email or password'
      });
    }
    
    // Remove password from user object
    const { password: _, ...userWithoutPassword } = user;
    
    console.log('Login successful for user:', user.username);
    
    // Ensure user object has required fields
    const userResponse = {
      _id: user._id,
      username: user.username,
      email: user.email,
      name: user.name || '',
      role: user.role || 'student',
      ...userWithoutPassword
    };
    
    // Determine redirect URL based on user role
    let redirectUrl = '/';
    if (user.role === 'tutor') {
      redirectUrl = '/tutor_dashboard.html';
    } else if (user.role === 'student') {
      redirectUrl = '/student_dashboard.html';
    }
    
    res.json({
      success: true,
      message: 'Login successful',
      user: userResponse,
      token: 'your-jwt-token-here',
      redirect: redirectUrl
    });
    
  } catch (error) {
    console.error('❌ Login error:', error);
    res.status(500).json({
      success: false,
      message: 'Error during login',
      error: error.message
    });
  }
});

// Signup endpoint
// Remove a student from a tutor
app.post('/api/remove-student', async (req, res) => {
    const { tutorUsername, studentUsername } = req.body;
    
    if (!tutorUsername || !studentUsername) {
        return res.status(400).json({
            success: false,
            message: 'Tutor username and student username are required'
        });
    }
    
    try {
        // Find the student
        const student = await db.collection('users').findOne({
            username: { $regex: `^${studentUsername}$`, $options: 'i' },
            role: 'student',
            assignedTutor: { $regex: `^${tutorUsername}$`, $options: 'i' }
        });
        
        if (!student) {
            return res.status(404).json({
                success: false,
                message: 'Student not found or not assigned to this tutor'
            });
        }
        
        // Remove the tutor assignment
        await db.collection('users').updateOne(
            { username: student.username },
            { $unset: { assignedTutor: '' } }
        );
        
        res.json({
            success: true,
            message: 'Student removed successfully'
        });
        
    } catch (error) {
        console.error('Error removing student:', error);
        res.status(500).json({
            success: false,
            message: 'Error removing student',
            error: error.message
        });
    }
});

// Tutor students endpoint
app.get('/api/tutor-students/:tutorUsername', async (req, res) => {
    try {
        const { tutorUsername } = req.params;
        
        console.log(`[DEBUG] ===== START REQUEST =====`);
        console.log(`[DEBUG] Path: ${req.originalUrl}`);
        console.log(`[DEBUG] Method: ${req.method}`);
        console.log(`[DEBUG] Params:`, req.params);
        console.log(`[DEBUG] Query:`, req.query);
        console.log(`[DEBUG] Headers:`, req.headers);
        console.log(`[DEBUG] Tutor username from params: ${tutorUsername}`);
        
        // Log all registered routes for debugging
        console.log(`[DEBUG] Registered routes:`);
        const routes = [];
        const router = app._router;
        router.stack.forEach((middleware) => {
            if (middleware.route) {
                // Routes registered directly on the app
                routes.push(`${Object.keys(middleware.route.methods).join(', ').toUpperCase()} ${middleware.route.path}`);
            } else if (middleware.name === 'router') {
                // Routes added with app.use()
                middleware.handle.stack.forEach((handler) => {
                    if (handler.route) {
                        routes.push(`${Object.keys(handler.route.methods).join(', ').toUpperCase()} ${middleware.regexp.toString().replace('/^', '').replace('\\/?', '').replace('(?=\\/|$)/i', '')}${handler.route.path}`);
                    }
                });
            }
        });
        console.log(routes.join('\n'));
        console.log(`[DEBUG] ========================`);
        
        if (!tutorUsername) {
            console.error('[ERROR] No tutorUsername provided in request');
            return res.status(400).json({
                success: false,
                message: 'Tutor username is required'
            });
        }
        
        // Find all students assigned to this tutor (case-insensitive match)
        const students = await db.collection('users').find({
            assignedTutor: { $regex: `^${tutorUsername}$`, $options: 'i' },
            role: 'student'
        }).toArray();
        
        // Return just the necessary student information
        const studentData = students.map(student => ({
            username: student.username,
            name: student.name || student.username,
            email: student.email
        }));
        
        console.log(`[DEBUG] Found ${studentData.length} students for tutor ${tutorUsername}`);
        
        res.json({
            success: true,
            students: studentData
        });
        
    } catch (error) {
        console.error('Error in /api/tutor-students:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching students',
            error: error.message
        });
    }
});

app.post('/api/signup', async (req, res) => {
  console.log('\n=== Signup Request ===');
  console.log('Headers:', JSON.stringify(req.headers, null, 2));
  console.log('Body:', JSON.stringify(req.body, null, 2));
  
  try {
    const { name, email, username, password, role, subject, availability, message } = req.body;
    
    // Validate required fields
    if (!name || !email || !username || !password || !role) {
      console.log('Missing required fields');
      return res.status(400).json({
        success: false,
        message: 'Name, email, username, password, and role are required'
      });
    }
    
    // Check if username or email already exists
    const existingUser = await db.collection('users').findOne({
      $or: [
        { username: { $regex: `^${username}$`, $options: 'i' } },
        { email: { $regex: `^${email}$`, $options: 'i' } }
      ]
    });
    
    if (existingUser) {
      const field = existingUser.username.toLowerCase() === username.toLowerCase() ? 'username' : 'email';
      console.log(`User with this ${field} already exists`);
      return res.status(400).json({
        success: false,
        message: `User with this ${field} already exists`
      });
    }
    
    // Hash the password
    const hashedPassword = await bcrypt.hash(password, 10);
    
    // Create user object
    const user = {
      name,
      email,
      username,
      password: hashedPassword,
      role,
      subject: subject || '',
      availability: availability || '',
      message: message || '',
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    // Insert user into database
    const result = await db.collection('users').insertOne(user);
    
    // Remove password from response
    const { password: _, ...userWithoutPassword } = user;
    
    console.log('User created successfully:', result.insertedId);
    
    res.status(201).json({
      success: true,
      message: 'User registered successfully',
      user: userWithoutPassword
    });
    
  } catch (error) {
    console.error('❌ Signup error:', error);
    res.status(500).json({
      success: false,
      message: 'Error creating user account',
      error: error.message
    });
  }
});

// Get all users (admin only)
app.get('/api/admin/users', async (req, res) => {
  console.log('\n=== Fetching all users ===');
  
  try {
    // In a real app, you would verify admin status here
    // For now, we'll just return all users
    const users = await db.collection('users').find({}).toArray();
    
    // Remove passwords from response
    const usersWithoutPasswords = users.map(({ password, ...user }) => user);
    
    console.log(`Found ${usersWithoutPasswords.length} users`);
    
    res.json({
      success: true,
      users: usersWithoutPasswords
    });
    
  } catch (error) {
    console.error('❌ Error fetching users:', error);
    res.status(500).json({
      success: false,
      message: 'Error fetching users',
      error: error.message
    });
  }
});

// Get assigned tutor for a student
app.get('/api/assigned-tutor/:username', async (req, res) => {
  const { username } = req.params;
  console.log(`\n=== Fetching assigned tutor for student: ${username} ===`);
  
  try {
    // First, find the student to get their assigned tutor
    const student = await db.collection('users').findOne({ 
      username: { $regex: `^${username}$`, $options: 'i' },
      role: 'student' 
    });
    
    if (!student) {
      console.log('Student not found');
      return res.status(404).json({
        success: false,
        message: 'Student not found'
      });
    }
    
    // If student has an assigned tutor, get their details
    if (student.assignedTutor) {
      const tutor = await db.collection('users').findOne({
        username: { $regex: `^${student.assignedTutor}$`, $options: 'i' },
        role: 'tutor'
      });
      
      if (tutor) {
        // Remove sensitive data before sending
        const { password, ...tutorData } = tutor;
        console.log('Found assigned tutor:', tutor.username);
        return res.json({
          success: true,
          tutor: tutorData
        });
      }
    }
    
    // If no assigned tutor or tutor not found
    console.log('No assigned tutor found for student');
    res.json({
      success: true,
      tutor: null,
      message: 'No tutor assigned'
    });
    
  } catch (error) {
    console.error('❌ Error fetching assigned tutor:', error);
    res.status(500).json({
      success: false,
      message: 'Error fetching assigned tutor',
      error: error.message
    });
  }
});

// Other API routes
app.use('/api', (req, res, next) => {
  // Handle other API routes here
  next();
});

// Start the server
app.listen(port, () => {
  console.log(`\n=== Server Started ===`);
  console.log(`🚀 Server running on http://0.0.0.0:${port}`);
  console.log('Available endpoints:');
  console.log('- GET  /');
  console.log('- GET  /login');
  console.log('- GET  /signup');
  console.log('- GET  /contact');
  console.log('- GET  /products');
  console.log('====================\n');
});
